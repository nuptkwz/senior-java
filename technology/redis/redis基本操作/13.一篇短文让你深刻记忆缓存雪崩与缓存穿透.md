[toc]

大家好，我是你们的船长：**科威舟**，今天给大家分享一下缓存雪崩与缓存穿透，相信一篇文章让你快速理解。


> 缓存，互联网系统的高速公路，一旦出问题就是连环车祸现场

## 为什么我们需要关注缓存问题？

想象一下，双十一零点，数百万用户同时涌入淘宝。突然，缓存系统崩溃，所有请求直接砸向数据库——这就是缓存雪崩的恐怖现场。作为后端开发者，不懂缓存问题，就像司机不懂交通规则，迟早要出大事。

缓存是现代互联网系统的**第一道防线**。它通过将数据暂存于访问速度更快的存储中，减少对底层数据库的直接访问，显著提升系统性能。但当这道防线出现问题时，系统可能会在瞬间崩溃。

## 缓存雪崩：缓存世界的"连环车祸"

### 什么是缓存雪崩？

缓存雪崩可以形象地理解为**高速路上的连环追尾事故**。当大量缓存数据在同一时间段内集中失效，就像多辆车同时刹车，导致后续车辆（请求）接连撞上（直接访问数据库），最终造成交通彻底瘫痪（数据库宕机）。

### 雪崩的深层原理

缓存雪崩的发生有两个主要原因：

1.  **大量缓存同时过期**：当多个缓存项设置了相同的过期时间，在某个时间点它们会同时失效，导致大量请求直接穿透到数据库。
2.  **缓存服务器宕机**：即使设置了合理的过期时间，如果缓存集群中某个节点发生故障，也会导致该节点上的所有缓存数据无法访问。

### 预防雪崩的四大实战策略

1.  **设置合理的过期时间**

    给不同的key设置**随机的过期时间**，避免大规模缓存同时失效。比如，可以在基础过期时间上增加一个随机值（如1-5分钟），让缓存失效时间点分布均匀。

2.  **构建高可用缓存集群**

    采用Redis主从复制+哨兵机制或Redis Cluster，实现缓存的高可用性。当某个节点宕机时，其他节点可以继续提供服务，避免全线崩溃。

3.  **多级缓存策略**

    设计二级缓存甚至多级缓存体系。例如，本地缓存（C1）作为一级缓存，Redis集群（C2）作为二级缓存。当一级缓存失效时，可以回退到二级缓存。

4.  **数据预热与定时更新**

    在系统低峰期（如凌晨），预先加载热点数据到缓存中。对于失效性要求不高的数据，可以通过定时任务在缓存失效前更新缓存。

## 缓存穿透：缓存世界的"伪造通行证"

### 什么是缓存穿透？

缓存穿透好比有人使用**伪造的通行证**试图进入高速路。这些请求对应的数据在缓存和数据库中**根本不存在**，每次请求都会绕过缓存直接访问数据库。

恶意攻击者可能会故意大量查询不存在的key（如不存在的用户ID），导致数据库压力大增甚至崩溃。

### 穿透的危害性

与雪崩不同，缓存穿透的特点是**即使系统正常运行，恶意请求也能直接攻击数据库**。这种攻击更难防范，因为它利用了系统的正常逻辑漏洞。

### 解决穿透的双重武器

1.  **布隆过滤器（Bloom Filter）**

    布隆过滤器是一种空间效率极高的概率型数据结构，用于判断一个元素是否存在于集合中。它可能产生误判（不存在判断为存在），但绝不会漏判（存在判断为不存在）。

    在实际应用中，可以将所有可能存在的key存入布隆过滤器，在查询缓存前先检查布隆过滤器。如果key不存在，直接返回，避免了对数据库的查询。

2.  **缓存空值**

    当查询返回空结果时，我们仍然将这个空结果缓存起来，并设置一个较短的过期时间（如30秒到5分钟）。这样，相同的请求在短时间内不会直接访问数据库。

## 缓存击穿：缓存世界的"明星塌房"

除了雪崩和穿透，还有一个值得关注的问题——缓存击穿。

### 什么是缓存击穿？

缓存击穿好比**某个大明星突然塌房**，导致全网搜索量激增。它指的是一个**热点key**在缓存过期的瞬间，大量并发请求直接击穿缓存，全部落到数据库上。

与雪崩不同，击穿是针对单个热点key的高并发请求，而雪崩是多个key的大规模失效。

### 应对击穿的实战方案

1.  **互斥锁（Mutex Key）**

    当缓存失效时，不立即加载数据库数据，而是先设置一个互斥锁。只有获取到锁的线程才能查询数据库并重建缓存，其他线程等待或重试。

2.  **热点数据永不过期**

    对极热点数据，可以设置其永不过期。通过后台异步更新策略，保证数据的时效性。

3.  **逻辑过期策略**

    不设置实际的过期时间，而是在value中存储过期时间戳。当发现数据将过期时，异步触发更新操作。

## 实战：构建全方位的缓存防护体系

在实际生产环境中，我们往往需要综合运用多种策略：

### 事前预防

- **多级缓存架构**：本地缓存+分布式缓存，提高系统韧性
- **容量规划**：合理评估缓存容量，设置适当的内存淘汰策略
- **监控预警**：对缓存命中率、内存使用率等关键指标进行监控

### 事中应对

- **限流降级**：使用Hystrix等组件在缓存失效时限制对数据库的访问量
- **动态调整**：根据系统负载动态调整缓存策略

### 事后恢复

- **快速故障转移**：当缓存集群出现问题时，快速切换到备用集群
- **数据恢复机制**：通过持久化机制快速重建缓存

## 结语

缓存雪崩、穿透和击穿是后端开发者必须面对的三大缓存难题。通过合理的策略组合，我们可以构建出健壮的缓存系统：

1.  **分散过期时间**，防止雪崩发生
2.  **布隆过滤器+空值缓存**，有效防止穿透攻击
3.  **互斥锁+热点数据永不过期**，应对击穿问题

记住，**没有银弹**，最适合的方案取决于你的具体业务场景。在高速发展的互联网时代，掌握缓存技术的内在原理与实践方案，是每一位后端工程师的必备技能。

希望本文能帮助你更好地理解缓存世界的"潜规则"，让你的系统在流量洪峰中屹立不倒！

---
更多技术干货欢迎关注微信公众号**科威舟的AI笔记**~

![](https://files.mdnice.com/user/101007/40fb2530-2565-4f14-a1df-8f581b1b1d70.png)

【转载须知】：**转载请注明原文出处及作者信息**

